name: Deploy

on:
  push:
    branches: [main]
    tags: [v*]
  pull_request:
    types: [opened, synchronize, reopened, closed]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write
  pull-requests: write

concurrency:
  group: "pages-${{ github.event_name }}-${{ github.ref }}"
  cancel-in-progress: true

jobs:
  # ---------------------------------------------------------------------------
  # Build — runs on all events except PR close
  # ---------------------------------------------------------------------------
  build:
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest
    outputs:
      deploy_type: ${{ steps.context.outputs.deploy_type }}
      deploy_path: ${{ steps.context.outputs.deploy_path }}
      should_deploy: ${{ steps.permissions.outputs.should_deploy }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine deployment context
        id: context
        run: |
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/tags/v* ]]; then
            TAG="${GITHUB_REF#refs/tags/}"
            echo "deploy_type=release" >> $GITHUB_OUTPUT
            echo "deploy_path=releases/${TAG}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "deploy_type=pr" >> $GITHUB_OUTPUT
            echo "deploy_path=pr/${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          else
            echo "deploy_type=nightly" >> $GITHUB_OUTPUT
            echo "deploy_path=nightly" >> $GITHUB_OUTPUT
          fi

      - name: Check deploy permissions
        id: permissions
        uses: actions/github-script@v7
        with:
          script: |
            if (context.eventName !== 'pull_request') {
              core.setOutput('should_deploy', 'true');
              return;
            }
            const { data } = await github.rest.repos.getCollaboratorPermissionLevel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              username: context.payload.pull_request.user.login
            });
            const hasAccess = ['admin', 'write'].includes(data.permission);
            console.log(`PR author: ${context.payload.pull_request.user.login}, permission: ${data.permission}`);
            core.setOutput('should_deploy', hasAccess.toString());

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build plugin
        run: bun run build

      - name: Build docs
        run: bun run docs:build

      - name: Stage deployment files
        run: |
          mkdir -p staging/plugin staging/docs
          cp dist/mcp.js staging/plugin/
          for f in dist/about.md dist/icon.svg; do
            [ -f "$f" ] && cp "$f" staging/plugin/
          done
          for f in docs/api.json docs/index.html docs/style.css; do
            [ -f "$f" ] && cp "$f" staging/docs/
          done

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: blockbench-mcp-plugin
          path: staging/
          retention-days: 30

  # ---------------------------------------------------------------------------
  # Deploy — pushes to gh-pages branch
  # ---------------------------------------------------------------------------
  deploy:
    needs: build
    if: needs.build.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: https://jasonjgardner.github.io/blockbench-mcp-plugin/
    steps:
      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 0
        continue-on-error: true

      - name: Initialize gh-pages if needed
        run: |
          if [ ! -f ".gitignore" ]; then
            printf 'node_modules\ndist/\n.claude\n' > .gitignore
          fi

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: blockbench-mcp-plugin
          path: ./staging

      - name: Deploy files
        env:
          DEPLOY_TYPE: ${{ needs.build.outputs.deploy_type }}
          DEPLOY_PATH: ${{ needs.build.outputs.deploy_path }}
        run: |
          copy_if_exists() {
            local dest="$1"; shift
            for f in "$@"; do
              [ -f "$f" ] && cp "$f" "$dest"
            done
          }

          # Always deploy plugin files to the target path
          mkdir -p "${DEPLOY_PATH}"
          copy_if_exists "${DEPLOY_PATH}/" staging/plugin/mcp.js staging/plugin/about.md staging/plugin/icon.svg

          # Release: also copy docs to target path + update root with everything
          if [[ "${DEPLOY_TYPE}" == "release" ]]; then
            copy_if_exists "${DEPLOY_PATH}/" staging/docs/api.json staging/docs/index.html staging/docs/style.css
            copy_if_exists ./ staging/plugin/mcp.js staging/plugin/about.md staging/plugin/icon.svg
            copy_if_exists ./ staging/docs/api.json staging/docs/index.html staging/docs/style.css
          fi

          # Nightly: update root docs only
          if [[ "${DEPLOY_TYPE}" == "nightly" ]]; then
            copy_if_exists ./ staging/docs/api.json staging/docs/index.html staging/docs/style.css
          fi

          # Clean up staging
          rm -rf staging

          echo "Deployed ${DEPLOY_TYPE} to ${DEPLOY_PATH}/"
          ls -la "${DEPLOY_PATH}/"

      - name: Commit and push
        env:
          DEPLOY_TYPE: ${{ needs.build.outputs.deploy_type }}
          DEPLOY_PATH: ${{ needs.build.outputs.deploy_path }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A

          case "${DEPLOY_TYPE}" in
            release) MSG="deploy: release ${DEPLOY_PATH##*/}" ;;
            pr)      MSG="deploy: PR #${DEPLOY_PATH##*/} preview" ;;
            *)       MSG="deploy: nightly build" ;;
          esac

          git commit -m "${MSG}" || echo "No changes to commit"
          git push origin gh-pages

      - name: Comment on PR
        if: needs.build.outputs.deploy_type == 'pr'
        uses: actions/github-script@v7
        with:
          script: |
            const deployPath = '${{ needs.build.outputs.deploy_path }}';
            const baseUrl = 'https://jasonjgardner.github.io/blockbench-mcp-plugin';

            const body = [
              '## Preview Deployment',
              '',
              'Your changes have been deployed for preview:',
              '',
              `**Plugin URL:** \`${baseUrl}/${deployPath}/mcp.js\``,
              '',
              'Load in Blockbench via File > Plugins > Load Plugin from URL.',
              '',
              '_This preview will be automatically cleaned up when the PR is closed._'
            ].join('\n');

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const existing = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('Preview Deployment')
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body
              });
            }

  # ---------------------------------------------------------------------------
  # Cleanup — removes PR preview when PR is closed
  # ---------------------------------------------------------------------------
  cleanup-pr:
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 0

      - name: Remove PR preview
        env:
          PR_NUM: ${{ github.event.pull_request.number }}
        run: |
          PR_PATH="pr/${PR_NUM}"

          if [ -d "${PR_PATH}" ]; then
            rm -rf "${PR_PATH}"

            # Remove empty pr/ directory
            if [ -d "pr" ] && [ -z "$(ls -A pr)" ]; then
              rm -rf "pr"
            fi

            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add -A
            git commit -m "chore: cleanup PR #${PR_NUM} preview" || echo "No changes"
            git push origin gh-pages
          fi
